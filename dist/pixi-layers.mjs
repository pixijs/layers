/*!
 * @pixi/layers - v2.1.0
 * Compiled Wed, 12 Jul 2023 13:34:29 UTC
 *
 * @pixi/layers is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 * 
 * Copyright 2023, Ivan Popelyshev, All Rights Reserved
 */import{DisplayObject as g,Container as d}from"@pixi/display";import{Renderer as v,utils as L,Rectangle as x,settings as m,RenderTexture as c}from"@pixi/core";function p(r){return function(e){if(!(this._activeParentLayer&&this._activeParentLayer!==e._activeLayer)){if(!this.visible){this.displayOrder=0;return}this.displayOrder=e.incDisplayOrder(),!(this.worldAlpha<=0||!this.renderable)&&(e._activeLayer=null,r.call(this,e),e._activeLayer=this._activeParentLayer)}}}function R(r){if(!(this._activeParentLayer&&this._activeParentLayer!==r._activeLayer)){if(!this.visible){this.displayOrder=0;return}this.displayOrder=r.incDisplayOrder(),!(this.worldAlpha<=0||!this.renderable)&&(r._activeLayer=null,this.containerRenderWebGL(r),r._activeLayer=this._activeParentLayer)}}function b(){if(g.prototype.displayOrder!==void 0)return;Object.assign(g.prototype,{parentLayer:null,_activeParentLayer:null,parentGroup:null,zOrder:0,zIndex:0,updateOrder:0,displayOrder:0,layerableChildren:!0,isLayer:!1});const r=d.prototype;r.containerRenderWebGL=r.render,r.render=R}function C(r){r.originalRenderWebGL||(r.originalRenderWebGL=r.render,r.render=p(r.render),r.renderCanvas&&(r.originalRenderWebGL=r.renderCanvas,r.renderCanvas=p(r.renderCanvas)))}function S(r){r.prototype.layerableChildren=!1,C(r.prototype)}function O(r){return function(e,t,s,i,n){(!t||!t.renderTexture&&!t.baseTexture)&&(this._lastDisplayOrder=0),this._activeLayer=null,e.isStage&&e.updateStage(),r.call(this,e,t,s,i,n)}}function y(r){const e=r.prototype;e._oldRender||(Object.assign(e,{_lastDisplayOrder:0,_activeLayer:null,incDisplayOrder(){return++this._lastDisplayOrder},_oldRender:v.prototype.render}),e._oldRender=e.render,e.render=O(e.render))}function P(r){if(!r){console.log("@pixi/layers: Canvas mixin was called with empty parameter. Are you sure that you even need this line?");return}y(r);const e=d.prototype;e.containerRenderCanvas||(e.containerRenderCanvas=e.renderCanvas,e.renderCanvas=p(e.renderCanvas))}const h=class extends L.EventEmitter{constructor(r=0,e=!1){super(),this.useRenderTexture=!1,this.useDoubleBuffer=!1,this.sortPriority=0,this.clearColor=new Float32Array([0,0,0,0]),this.canDrawWithoutLayer=!1,this.canDrawInParentStage=!0,this._activeLayer=null,this._activeStage=null,this._activeChildren=[],this._lastUpdateId=-1,this.zIndex=r||0,this.enableSort=!!e,typeof e=="function"&&this.on("sort",e)}doSort(r,e){if(this.listeners("sort",!0))for(let t=0;t<e.length;t++)this.emit("sort",e[t]);e.sort(h.compareZIndex)}static compareZIndex(r,e){return r.zOrder<e.zOrder?-1:r.zOrder>e.zOrder?1:r.updateOrder-e.updateOrder}clear(){this._activeLayer=null,this._activeStage=null,this._activeChildren.length=0}_resolveChildDisplayObject(r,e){this.check(r),e._activeParentLayer=this._activeLayer,this._activeLayer?this._activeLayer._activeChildren.push(e):this._activeChildren.push(e)}_resolveLayer(r,e){this.check(r),this._activeLayer&&h.conflict(),this._activeLayer=e,this._activeStage=r}check(r){if(this._lastUpdateId<h._layerUpdateId)this._lastUpdateId=h._layerUpdateId,this.clear(),this._activeStage=r;else if(this.canDrawInParentStage){let e=this._activeStage;for(;e&&e!==r;)e=e._activeParentStage;this._activeStage=e,e===null&&this.clear()}}static conflict(){h._lastLayerConflict+5e3<Date.now()&&(h._lastLayerConflict=Date.now(),console.log("@pixi/layers found two layers with the same group in one stage - that's not healthy. Please place a breakpoint here and debug it"))}};let u=h;u._layerUpdateId=0,u._lastLayerConflict=0;class f{constructor(e){this.layer=e,this.renderTexture=null,this.doubleBuffer=null,this.currentBufferIndex=0,this._tempRenderTarget=null,this._tempRenderTargetSource=new x,this._tempRenderTargetDestination=new x}init(e){const t=e?e.screen.width:100,s=e?e.screen.height:100,i=e?e.resolution:m.RESOLUTION;this.renderTexture=c.create({width:t,height:s,resolution:i}),this.layer.group.useDoubleBuffer&&(this.doubleBuffer=[c.create({width:t,height:s,resolution:i}),c.create({width:t,height:s,resolution:i})])}getRenderTexture(){return this.renderTexture||this.init(),this.renderTexture}pushTexture(e){const t=e.screen;this.renderTexture||this.init(e);const s=this.renderTexture,i=this.layer.group,n=this.doubleBuffer;if((s.width!==t.width||s.height!==t.height||s.baseTexture.resolution!==e.resolution)&&(s.baseTexture.resolution=e.resolution,s.resize(t.width,t.height),n&&(n[0].baseTexture.resolution=e.resolution,n[0].resize(t.width,t.height),n[1].baseTexture.resolution=e.resolution,n[1].resize(t.width,t.height))),n&&(n[0].framebuffer.multisample=s.framebuffer.multisample,n[1].framebuffer.multisample=s.framebuffer.multisample),this._tempRenderTarget=e.renderTexture.current,this._tempRenderTargetSource.copyFrom(e.renderTexture.sourceFrame),this._tempRenderTargetDestination.copyFrom(e.renderTexture.destinationFrame),e.batch.flush(),i.useDoubleBuffer){let a=n[this.currentBufferIndex];a.baseTexture._glTextures[e.CONTEXT_UID]||(e.renderTexture.bind(a,void 0,void 0),e.texture.bind(a),i.clearColor&&e.renderTexture.clear(i.clearColor)),e.texture.unbind(s.baseTexture),s.baseTexture._glTextures=a.baseTexture._glTextures,s.baseTexture.framebuffer=a.baseTexture.framebuffer,a=n[1-this.currentBufferIndex],e.renderTexture.bind(a,void 0,void 0)}else e.renderTexture.bind(s,void 0,void 0);i.clearColor&&e.renderTexture.clear(i.clearColor);const l=e.filter.defaultFilterStack;l.length>1&&(l[l.length-1].renderTexture=e.renderTexture.current)}popTexture(e){e.batch.flush(),e.framebuffer.blit();const t=e.filter.defaultFilterStack;t.length>1&&(t[t.length-1].renderTexture=this._tempRenderTarget),e.renderTexture.bind(this._tempRenderTarget,this._tempRenderTargetSource,this._tempRenderTargetDestination),this._tempRenderTarget=null;const s=this.renderTexture,i=this.layer.group,n=this.doubleBuffer;if(i.useDoubleBuffer){e.texture.unbind(s.baseTexture),this.currentBufferIndex=1-this.currentBufferIndex;const l=n[this.currentBufferIndex];s.baseTexture._glTextures=l.baseTexture._glTextures,s.baseTexture.framebuffer=l.baseTexture.framebuffer}}destroy(){this.renderTexture&&(this.renderTexture.destroy(),this.doubleBuffer&&(this.doubleBuffer[0].destroy(!0),this.doubleBuffer[1].destroy(!0)))}}class o extends d{constructor(e=null){super(),this.isLayer=!0,this.group=null,this._activeChildren=[],this._tempChildren=null,this._activeStageParent=null,this._sortedChildren=[],this._tempLayerParent=null,this.insertChildrenBeforeActive=!0,this.insertChildrenAfterActive=!0,e?(this.group=e,this.zIndex=e.zIndex):this.group=new u(0,!1),this._tempChildren=this.children}get useRenderTexture(){return this.group.useRenderTexture}set useRenderTexture(e){this.group.useRenderTexture=e}get useDoubleBuffer(){return this.group.useDoubleBuffer}set useDoubleBuffer(e){this.group.useDoubleBuffer=e}get clearColor(){return this.group.clearColor}set clearColor(e){this.group.clearColor=e}get sortPriority(){return this.group.sortPriority}set sortPriority(e){this.group.sortPriority=e}getRenderTexture(){return this.textureCache||(this.textureCache=new f(this)),this.textureCache.getRenderTexture()}doSort(){this.group.doSort(this,this._sortedChildren)}destroy(e){this.textureCache&&(this.textureCache.destroy(),this.textureCache=null),super.destroy(e)}render(e){this.prerender(e)&&(this.group.useRenderTexture&&(this.textureCache||(this.textureCache=new f(this)),this.textureCache.pushTexture(e)),this.containerRenderWebGL(e),this.postrender(e),this.group.useRenderTexture&&this.textureCache.popTexture(e))}layerRenderCanvas(e){this.prerender(e)&&(this.containerRenderCanvas(e),this.postrender(e))}_onBeginLayerSubtreeTraversal(e){const t=this._activeChildren;this._activeStageParent=e,this.group._resolveLayer(e,this);const s=this.group._activeChildren;t.length=0;for(let i=0;i<s.length;i++)s[i]._activeParentLayer=this,t.push(s[i]);s.length=0}_onEndLayerSubtreeTraversal(){const e=this.children,t=this._activeChildren,s=this._sortedChildren;for(let i=0;i<t.length;i++)this.emit("display",t[i]);if(s.length=0,this.insertChildrenBeforeActive)for(let i=0;i<e.length;i++)s.push(e[i]);for(let i=0;i<t.length;i++)s.push(t[i]);if(!this.insertChildrenBeforeActive&&this.insertChildrenAfterActive)for(let i=0;i<e.length;i++)s.push(e[i]);this.group.enableSort&&this.doSort()}prerender(e){return this._activeParentLayer&&this._activeParentLayer!=e._activeLayer?!1:this.visible?(this.displayOrder=e.incDisplayOrder(),this.worldAlpha<=0||!this.renderable?!1:(this.children!==this._sortedChildren&&this._tempChildren!==this.children&&(this._tempChildren=this.children),this._boundsID++,this.children=this._sortedChildren,this._tempLayerParent=e._activeLayer,e._activeLayer=this,!0)):(this.displayOrder=0,!1)}postrender(e){this.children=this._tempChildren,e._activeLayer=this._tempLayerParent,this._tempLayerParent=null}}o.prototype.renderCanvas=o.prototype.layerRenderCanvas;const _=class extends o{constructor(){super(...arguments),this.isStage=!0,this._tempGroups=[],this._activeLayers=[],this._activeParentStage=null}clear(){this._activeLayers.length=0,this._tempGroups.length=0}destroy(r){this.clear(),super.destroy(r)}updateStage(){this._activeParentStage=null,u._layerUpdateId++,this._updateStageInner()}updateAsChildStage(r){this._activeParentStage=r,_._updateOrderCounter=0,this._updateStageInner()}_updateStageInner(){this.clear(),this._addRecursive(this);const r=this._activeLayers;for(let e=0;e<r.length;e++){const t=r[e];if(t.group.sortPriority){t._onEndLayerSubtreeTraversal();const s=t._sortedChildren;for(let i=0;i<s.length;i++)this._addRecursiveChildren(s[i])}}for(let e=0;e<r.length;e++){const t=r[e];t.group.sortPriority||t._onEndLayerSubtreeTraversal()}}_addRecursive(r){if(!r.visible)return;if(r.isLayer){const i=r;this._activeLayers.push(i),i._onBeginLayerSubtreeTraversal(this)}if(r!==this&&r.isStage){r.updateAsChildStage(this);return}r._activeParentLayer=null;let e=r.parentGroup;e&&e._resolveChildDisplayObject(this,r);const t=r.parentLayer;if(t&&(e=t.group,e._resolveChildDisplayObject(this,r)),r.updateOrder=++_._updateOrderCounter,r.alpha<=0||!r.renderable||!r.layerableChildren||e&&e.sortPriority)return;const s=r.children;if(s&&s.length)for(let i=0;i<s.length;i++)this._addRecursive(s[i])}_addRecursiveChildren(r){if(r.alpha<=0||!r.renderable||!r.layerableChildren)return;const e=r.children;if(e&&e.length)for(let t=0;t<e.length;t++)this._addRecursive(e[t])}};let T=_;T._updateOrderCounter=0,b(),y(v);export{u as Group,o as Layer,f as LayerTextureCache,T as Stage,P as applyCanvasMixin,C as applyContainerRenderMixin,b as applyDisplayMixin,S as applyParticleMixin,y as applyRendererMixin};
//# sourceMappingURL=pixi-layers.mjs.map
